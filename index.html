<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Happy Birthday Prarthna!</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        canvas { display: block; background: #4a7844; margin: 0 auto; border: 5px solid #fff; outline: none; }
        
        #splash-screen {
            position: absolute; width: 100%; height: 100%; background: #1a1a1a;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .ransom-text { display: flex; flex-wrap: wrap; justify-content: center; }
        .letter {
            font-size: 60px; padding: 10px 15px; margin: 5px; font-weight: bold;
            text-transform: uppercase; display: inline-block; border: 2px solid #000;
        }
        .l1 { background: #ffed00; color: #000; transform: rotate(-5deg); font-family: 'Courier New'; }
        .l2 { background: #e60012; color: #fff; transform: rotate(3deg); font-family: 'Georgia'; }
        .l3 { background: #00a0e9; color: #fff; transform: rotate(-2deg); font-family: 'Arial'; border-radius: 5px; }
        .l4 { background: #fff; color: #000; transform: rotate(4deg); font-family: 'Times New Roman'; border: 1px dashed #000; }

        #start-btn {
            margin-top: 50px; padding: 15px 30px; font-size: 20px; cursor: pointer;
            background: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold;
        }

        /* IMPROVED UI BOX */
        #ui { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            width: 70%; background: white; padding: 25px; border-radius: 15px; 
            display: none; border: 5px solid #333; z-index: 200; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        #close-btn {
            position: absolute; top: 10px; right: 10px; background: #e60012; color: white;
            border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body onclick="handleGlobalClick()">

<div id="splash-screen">
    <h1 style="color: white; font-family: sans-serif;">HAPPY BIRTHDAY</h1>
    <div class="ransom-text">
        <span class="letter l1">P</span>
        <span class="letter l2">R</span>
        <span class="letter l3">A</span>
        <span class="letter l4">R</span>
        <span class="letter l1">T</span>
        <span class="letter l2">H</span>
        <span class="letter l3">N</span>
        <span class="letter l4">A</span>
    </div>
    <button id="start-btn" onclick="startGame(event)">ENTER THE QUEST</button>
</div>

<canvas id="gameCanvas" tabindex="1"></canvas>

<div id="ui">
    <button id="close-btn" onclick="closeDialog(event)">X</button>
    <h2 id="speaker-name" style="margin:0; color:#e60012;">Name</h2>
    <p id="message-text" style="font-size:22px; line-height: 1.4;">Message...</p>
    <strong style="color: #666;">(CLICK ANYWHERE TO CLOSE)</strong>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui');
canvas.width = 800;
canvas.height = 600;

const worldWidth = 2000;
const worldHeight = 2000;

let gameActive = false;
let isDialogOpen = false;
let dialogueCooldown = 0; 
let friendsFound = 0;
let cakeExploded = false;
let particles = [];
let shownCakeQuest = false; // Tracks if we told the player to find the cake

const playerImg = new Image(); playerImg.src = 'player.png';
const friends = [
    { name: "Kanishkaa", x: 200, y: 200, imgPath: 'f1.png', msg: "Happy Birthday to the one whoâ€™s not just my best friend but my elder sister by heart. You guide me, explain things no one has ever have and probably will never to me, and always look out for me. Iâ€™m so grateful to have you in my life. I will love you no matter what u are or who u are.. Always be yourself. Once again happy birthday! LOVE UU A LOOTT (pluto)... Hope u stay happy and healthy all the time.", found: false },
    { name: "Aanya", x: 1800, y: 200, imgPath: 'f2.png', msg: "Heyy! Happy Birthday, Prarthna!! I hope this year brings you everything you wish for and more. Never stop being the amazing, kind and genuine person you are. You truly make people around you so happy. Have the most wonderful birthday ever!", found: false },
    { name: "Nishchita", x: 200, y: 1800, imgPath: 'f3.png', msg: "nish msg", found: false},
    { name: "Patrina", x: 1800, y: 1800, imgPath: 'f4.png', msg: "pat msg", found: false },
    { name: "Parthvi", x: 1000, y: 300, imgPath: 'f5.png', msg: "par msg", found: false},
    { name: "Ananya", x: 300, y: 1000, imgPath: 'f6.png', msg: "any msg", found: false},
];

friends.forEach(f => { f.img = new Image(); f.img.src = f.imgPath; });

const player = { x: 1000, y: 1000, speed: 7, size: 50 };
const keys = {};

function closeDialog(e) {
    if(e) e.stopPropagation();
    isDialogOpen = false;
    ui.style.display = 'none';
    dialogueCooldown = 100; 
    canvas.focus();
}

function handleGlobalClick() {
    if (isDialogOpen) closeDialog();
}

window.addEventListener('keydown', e => { 
    if (e.code === 'Space') {
        e.preventDefault(); 
        if (isDialogOpen) closeDialog();
    }
    keys[e.code] = true; 
});
window.addEventListener('keyup', e => keys[e.code] = false);

function startGame(e) {
    e.stopPropagation(); 
    document.getElementById('splash-screen').style.display = 'none';
    gameActive = true;
    canvas.focus();
    draw();
}

function drawBackground() {
    ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
    for (let x = 0; x <= worldWidth; x += 100) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, worldHeight); ctx.stroke();
    }
    for (let y = 0; y <= worldHeight; y += 100) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(worldWidth, y); ctx.stroke();
    }
    ctx.font = "20px Arial";
    for(let i=0; i<80; i++) {
        let fx = (i * 12345) % worldWidth;
        let fy = (i * 67890) % worldHeight;
        ctx.fillText("ðŸŒ¸", fx, fy);
    }
}

class Particle {
    constructor(x, y) {
        this.x = x; this.y = y;
        let angle = Math.random() * Math.PI * 2;
        let speed = Math.random() * 8 + 2;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
        this.life = 100;
    }
    update() { this.x += this.vx; this.y += this.vy; this.vy += 0.2; this.life--; }
    draw() { ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 6, 6); }
}

function update() {
    if (!gameActive || isDialogOpen) return;

    if (dialogueCooldown > 0) dialogueCooldown--; 

    if (keys['ArrowUp'] || keys['KeyW']) player.y -= player.speed;
    if (keys['ArrowDown'] || keys['KeyS']) player.y += player.speed;
    if (keys['ArrowLeft'] || keys['KeyA']) player.x -= player.speed;
    if (keys['ArrowRight'] || keys['KeyD']) player.x += player.speed;

    player.x = Math.max(0, Math.min(worldWidth - player.size, player.x));
    player.y = Math.max(0, Math.min(worldHeight - player.size, player.y));

    if (dialogueCooldown <= 0) {
        friends.forEach(f => {
            let dist = Math.hypot(player.x - f.x, player.y - f.y);
            if (dist < 60 && !isDialogOpen) {
                isDialogOpen = true;
                document.getElementById('speaker-name').innerText = f.name;
                document.getElementById('message-text').innerText = f.msg;
                ui.style.display = 'block';
                if(!f.found) { f.found = true; friendsFound++; }
            }
        });
    }

    // NEW LOGIC: Trigger Cake Search instruction
    if (friendsFound === 6 && !shownCakeQuest && !isDialogOpen) {
        shownCakeQuest = true;
        isDialogOpen = true;
        document.getElementById('speaker-name').innerText = "SYSTEM";
        document.getElementById('message-text').innerText = "All friends found! Go to the CENTER of the map (follow the green dot on the mini-map) to find your Birthday Cake!";
        ui.style.display = 'block';
    }

    if (friendsFound === 6 && !cakeExploded) {
        if (Math.hypot(player.x - 1000, player.y - 1000) < 60) {
            cakeExploded = true;
            for(let i=0; i<150; i++) particles.push(new Particle(1000, 1000));
        }
    }
}

function draw() {
    if (!gameActive) return;
    update(); 

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    let camX = Math.max(0, Math.min(worldWidth - canvas.width, player.x - canvas.width / 2));
    let camY = Math.max(0, Math.min(worldHeight - canvas.height, player.y - canvas.height / 2));

    ctx.save();
    ctx.translate(-camX, -camY);
    drawBackground();

    friends.forEach(f => {
        ctx.fillStyle = "#333";
        ctx.fillRect(f.x - 10, f.y, 20, 30);
        if (f.img.complete && f.img.naturalWidth !== 0) {
            ctx.drawImage(f.img, f.x - 25, f.y - 70, 50, 80);
        } else {
            ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(f.x, f.y - 15, 20, 0, Math.PI * 2); ctx.fill();
        }
        if(!f.found) {
            ctx.fillStyle = "white"; ctx.font = "bold 20px Arial";
            ctx.fillText("?", f.x - 5, f.y - 80);
        }
    });

    if (friendsFound === 6 && !cakeExploded) {
        ctx.font = "60px Arial";
        ctx.fillText("ðŸŽ‚", 1000 - 30, 1000 + 30);
    }

    particles.forEach((p, i) => {
        p.update(); p.draw();
        if(p.life <= 0) particles.splice(i, 1);
    });

    // Player
    ctx.fillStyle = "#000"; ctx.fillRect(player.x + 15, player.y + 30, 20, 20);
    if (playerImg.complete && playerImg.naturalWidth !== 0) {
        ctx.drawImage(playerImg, player.x, player.y, player.size, player.size);
    } else {
        ctx.fillStyle = "#ff00ff"; ctx.fillRect(player.x, player.y, 50, 80);
    }

    ctx.restore();

    // MINI-MAP
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(640, 10, 150, 150);
    ctx.strokeStyle = "white";
    ctx.strokeRect(640, 10, 150, 150);
    ctx.fillStyle = "lime";
    ctx.fillRect(640 + (player.x/worldWidth)*150, 10 + (player.y/worldHeight)*150, 4, 4);
    
    // Add cake location to map after finding everyone
    if(friendsFound === 6) {
        ctx.fillStyle = "yellow";
        ctx.beginPath();
        ctx.arc(640 + (1000/worldWidth)*150, 10 + (1000/worldHeight)*150, 3, 0, Math.PI*2);
        ctx.fill();
    }

    friends.forEach(f => {
        ctx.fillStyle = f.found ? "gray" : "red";
        ctx.fillRect(640 + (f.x/worldWidth)*150, 10 + (f.y/worldHeight)*150, 3, 3);
    });

    ctx.fillStyle = "white"; ctx.font = "bold 16px Arial";
    ctx.fillText(`Found: ${friendsFound}/6`, 20, 30);
    if(cakeExploded) {
        ctx.fillStyle = "yellow"; ctx.font = "bold 40px Arial";
        ctx.fillText("HAPPY BIRTHDAY PRARTHNA!", 100, 300);
    }

    requestAnimationFrame(draw);
}
</script>
</body>
</html>